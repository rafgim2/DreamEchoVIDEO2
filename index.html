<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DreamEcho - Artista</title>
  <style>
    html, body { height:100%; margin:0; font-family:sans-serif; background-color:#f5f5f5; }
    body { display:flex; justify-content:center; align-items:center; text-align:center; }
    .container { max-width:600px; width:90%; padding:2em; background:white; border-radius:1em; border:3px solid orange; box-shadow:0 0 20px rgba(0,0,0,0.1); }
    h1 { font-size:3em; margin-bottom:.2em; }
    video { width:100%; max-height:300px; border-radius:.5em; margin-bottom:1em; background:black; }
    .byline { margin-bottom:.8em; font-size:.9em; }
    .byline a { color:#333; text-decoration:none; }
    .byline a:hover { text-decoration:underline; }
    p { font-size:1.2em; margin:.5em 0; }
    #chatLog { height:150px; overflow-y:auto; border:1px solid #ccc; padding:.5em; margin-bottom:.5em; text-align:left; background:#fafafa; }
    #chatInput { width:70%; padding:.5em; font-size:1em; }
    #sendChatBtn { padding:.6em 1em; font-size:1em; cursor:pointer; margin-left:.5em; }
    #midiLabel { font-size:1em; margin-right:.5em; }
    #midiSelect { margin:1em 0; padding:.5em; font-size:1em; }
    .msg-artista { color:blue; }
  </style>
</head>
<body>
  <div class="container">
    <h1>DreamEcho - Artista</h1>
    <p class="byline"><a href="https://www.youtube.com/@rafgim" target="_blank" rel="noopener">¬© By Rafael Gimeno</a></p>
    <video id="localVideo" autoplay muted playsinline></video>
    <p id="estado">Conectando...</p>
    <p id="oyentes">Oyentes conectados: --</p>

    <div id="midiControles" style="display:none;"><label id="midiLabel" for="midiSelect">Selecciona tu dispositivo MIDI:</label><select id="midiSelect"></select></div>
    <div id="chatControles"><div id="chatLog"></div><input id="chatInput" placeholder="Escribe tu mensaje‚Ä¶" /><button id="sendChatBtn">üó®Ô∏è Enviar</button></div>
  </div>

  <script>
    // Elementos del DOM
    const estadoEl = document.getElementById('estado');
    const oyentesEl = document.getElementById('oyentes');
    const chatLog = document.getElementById('chatLog');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const midiControles = document.getElementById('midiControles');
    const midiSelect = document.getElementById('midiSelect');
    const localVideo = document.getElementById('localVideo');

    // WebSocket para se√±alizaci√≥n y chat
    const ws = new WebSocket('wss://dreamecho.onrender.com');
    // PeerConnection para WebRTC
    const pc = new RTCPeerConnection({ iceServers:[{ urls:'stun:stun.l.google.com:19302' }] });

    let midiChannel = null;
    let activeMIDIInput = null;
    let startTime = null;
    let prevClients = 0;
    const username = prompt('¬øC√≥mo quieres que te vean en el chat?', 'Artista') || 'Artista';

    // Enviar se√±alizaci√≥n por WS
    function sendSignal(data) {
      console.log('Enviando se√±al:', data);
      ws.send(JSON.stringify({ type: 'signal', ...data }));
    }

    // Manejo de mensajes WS
    ws.onopen = () => {
      estadoEl.innerText = 'Conectado. Iniciando WebRTC...';
      startWebRTC();
    };
    ws.onmessage = async ({ data }) => {
      const raw = typeof data === 'string' ? data : await data.text();
      const msg = JSON.parse(raw);
      console.log('WS recibido:', msg);

      if (msg.type === 'stats') {
        const clients = msg.clients;
        oyentesEl.innerText = `Oyentes conectados: ${clients}`;
        // Si hay m√°s oyentes (no el primer mensaje), renegociamos
        if (prevClients > 0 && clients > prevClients) {
          console.log('Nuevo oyente detectado, renegociando...');
          startWebRTC();
        }
        prevClients = clients;
        return;
      }
      if (msg.type === 'chat') {
        appendChat(msg.user, msg.text);
        return;
      }
      if (msg.type === 'signal') {
        // Se√±alizaci√≥n WebRTC
        if (msg.offer) {
          console.log('Recibida oferta, respondiendo...');
          await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          sendSignal({ answer: pc.localDescription });
        }
        if (msg.answer) {
          console.log('Recibida respuesta, aplicando SDP...');
          await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
        }
        if (msg.candidate) {
          console.log('Recibido candidato ICE, a√±adiendo...');
          await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
        }
      }
    };
    ws.onerror = err => {
      console.error('WS error:', err);
      estadoEl.innerText = 'Error en la conexi√≥n.';
    };
    ws.onclose = () => {
      console.warn('WS cerrado');
      estadoEl.innerText = 'Conexi√≥n cerrada.';
    };

    // ICE: enviar candidatos
    pc.onicecandidate = ({ candidate }) => {
      if (candidate) sendSignal({ candidate });
    };

    // Captura de v√≠deo y negociaci√≥n
    async function startWebRTC() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => pc.addTrack(track, stream));
        localVideo.srcObject = stream;
        // Canal MIDI sobre WebRTC
        if (!midiChannel || midiChannel.readyState === 'closed') {
          midiChannel = pc.createDataChannel('midi');
          midiChannel.onopen = () => {
            console.log('Canal MIDI WebRTC abierto');
            estadoEl.innerText += ' | Canal MIDI listo';
          };
        }
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        console.log('Enviando oferta WebRTC');
        sendSignal({ offer: pc.localDescription });
      } catch (err) {
        console.error('Error WebRTC:', err);
        estadoEl.innerText = 'Error al iniciar WebRTC.';
      }
    }

    // Chat
    function appendChat(user, text) {
      const msgEl = document.createElement('div');
      const time = new Date().toLocaleTimeString();
      if (user === username) msgEl.classList.add('msg-artista');
      msgEl.innerHTML = `<small>[${time}]</small> <strong>${user}:</strong> ${text}`;
      chatLog.appendChild(msgEl);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    function sendChat() {
      const text = chatInput.value.trim();
      if (!text || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'chat', user: username, text }));
      chatInput.value = '';
    }
    sendChatBtn.addEventListener('click', sendChat);
    chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendChat(); });

    // MIDI local
    navigator.requestMIDIAccess().then(midiAccess => {
      const inputs = midiAccess.inputs;
      if (inputs.size === 0) {
        estadoEl.innerText = 'No se detectaron dispositivos MIDI.';
        return;
      }
      midiControles.style.display = 'block';
      inputs.forEach((input, id) => {
        const opt = document.createElement('option'); opt.value = id; opt.text = input.name;
        midiSelect.appendChild(opt);
      });
      midiSelect.addEventListener('change', () => selectMIDI(midiSelect.value, midiAccess));
      selectMIDI(midiSelect.value, midiAccess);
      estadoEl.innerText = 'Selecciona un dispositivo MIDI para empezar a transmitir.';
    }).catch(() => {
      estadoEl.innerText = 'No se pudo acceder al MIDI.';
    });

    function selectMIDI(id, midiAccess) {
      if (activeMIDIInput) activeMIDIInput.onmidimessage = null;
      const input = midiAccess.inputs.get(id);
      if (input) {
        input.onmidimessage = ({ data }) => {
          const now = performance.now();
          if (!startTime) startTime = now;
          const rel = now - startTime;
          if (midiChannel && midiChannel.readyState === 'open') {
            midiChannel.send(JSON.stringify({ data: Array.from(data), time: rel }));
          }
        };
        activeMIDIInput = input;
        estadoEl.innerText = `Transmitiendo desde: ${input.name}`;
      } else {
        estadoEl.innerText = 'Dispositivo MIDI no encontrado.';
      }
    }
  </script>
</body>
</html>
