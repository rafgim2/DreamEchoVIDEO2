<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DreamEcho - Artista</title>
  <style>
    html, body { height:100%; margin:0; font-family:sans-serif; background-color:#f5f5f5; }
    body { display:flex; justify-content:center; align-items:center; text-align:center; }
    .container { max-width:600px; width:90%; padding:2em; background:white; border-radius:1em; border:3px solid orange; box-shadow:0 0 20px rgba(0,0,0,0.1); }
    h1 { font-size:3em; margin-bottom:.2em; }
    video { width:100%; max-height:300px; border-radius:.5em; margin-bottom:1em; background:black; }
    .byline { margin-bottom:.8em; font-size:.9em; }
    .byline a { color:#333; text-decoration:none; }
    .byline a:hover { text-decoration:underline; }
    p { font-size:1.2em; margin:.5em 0; }
    #chatLog { height:150px; overflow-y:auto; border:1px solid #ccc; padding:.5em; margin-bottom:.5em; text-align:left; background:#fafafa; }
    #chatInput { width:70%; padding:.5em; font-size:1em; }
    #sendChatBtn { padding:.6em 1em; font-size:1em; cursor:pointer; margin-left:.5em; }
    #midiLabel { font-size:1em; margin-right:.5em; }
    #midiSelect { margin:1em 0; padding:.5em; font-size:1em; }
    .msg-artista { color:blue; }
  </style>
</head>
<body>
  <div class="container">
    <h1>DreamEcho - Artista</h1>
    <p class="byline"><a href="https://www.youtube.com/@rafgim" target="_blank" rel="noopener">¬© By Rafael Gimeno</a></p>
    <video id="localVideo" autoplay muted playsinline></video>
    <p id="estado">Conectando...</p>
    <p id="oyentes">Oyentes conectados: --</p>

    <div id="midiControles" style="display:none;"><label id="midiLabel" for="midiSelect">Selecciona tu dispositivo MIDI:</label><select id="midiSelect"></select></div>
    <div id="chatControles"><div id="chatLog"></div><input id="chatInput" placeholder="Escribe tu mensaje‚Ä¶" /><button id="sendChatBtn">üó®Ô∏è Enviar</button></div>
  </div>

  <script>
    const estadoEl = document.getElementById('estado');
    const oyentesEl = document.getElementById('oyentes');
    const chatLog = document.getElementById('chatLog');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const midiControles = document.getElementById('midiControles');
    const midiSelect = document.getElementById('midiSelect');
    const localVideo = document.getElementById('localVideo');

    const ws = new WebSocket('wss://dreamecho.onrender.com');
    const pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
    let midiChannel, activeMIDIInput, startTime;
    const username = prompt('¬øC√≥mo quieres que te vean en el chat?','Artista')||'Artista';

    // Se√±alizaci√≥n WebSocket
    function sendSignal(data){ ws.send(JSON.stringify({type:'signal', ...data})); }
    ws.onopen = ()=>{ estadoEl.innerText='Conectado. Iniciando WebRTC...'; startWebRTC(); };
    ws.onmessage = async event=>{
      const text = typeof event.data==='string'?event.data:await event.data.text();
      const msg = JSON.parse(text);
      if(msg.type==='stats'){
        oyentesEl.innerText=`Oyentes conectados: ${msg.clients}`;
        return;
      }
      if(msg.type==='chat'){
        appendChat(msg.user,msg.text);
        return;
      }
      if(msg.type==='signal'){
        if(msg.offer){
          await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
          const ans = await pc.createAnswer();
          await pc.setLocalDescription(ans);
          sendSignal({answer: pc.localDescription});
        }
        if(msg.answer){
          await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
        }
        if(msg.candidate){
          await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
        }
      }
    };
    ws.onerror = ()=>{ estadoEl.innerText='Error en la conexi√≥n.'; };
    ws.onclose = ()=>{ estadoEl.innerText='Conexi√≥n cerrada.'; };

    pc.onicecandidate = ({candidate})=>{ if(candidate) sendSignal({candidate}); };

    // Captura y oferta WebRTC
    async function startWebRTC(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({video:true});
        stream.getTracks().forEach(t=>pc.addTrack(t,stream));
        localVideo.srcObject=stream;
        // Canal MIDI
        midiChannel = pc.createDataChannel('midi');
        midiChannel.onopen = ()=>{ estadoEl.innerText+=' | Canal MIDI listo'; };
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        sendSignal({offer:pc.localDescription});
      }catch(e){ console.error('WebRTC error:',e); estadoEl.innerText='Error al iniciar WebRTC.';} }

    // Chat
    function appendChat(user,text){ const d=document.createElement('div'); const t=new Date().toLocaleTimeString();
      if(user===username) d.classList.add('msg-artista');
      d.innerHTML=`<small>[${t}]</small> <strong>${user}:</strong> ${text}`;
      chatLog.appendChild(d); chatLog.scrollTop=chatLog.scrollHeight; }
    function sendChat(){ const t=chatInput.value.trim(); if(!t||ws.readyState!==WebSocket.OPEN)return; ws.send(JSON.stringify({type:'chat',user:username,text:t})); chatInput.value=''; }
    sendChatBtn.addEventListener('click',sendChat); chatInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendChat();});

    // MIDI
    navigator.requestMIDIAccess().then(ma=>{
      const inputs=Array.from(ma.inputs.values());
      if(!inputs.length){ estadoEl.innerText='No se detectaron dispositivos MIDI.'; return; }
      midiControles.style.display='block';
      inputs.forEach(inp=>{
        const opt=document.createElement('option'); opt.value=inp.id; opt.text=inp.name; midiSelect.appendChild(opt);
      });
      midiSelect.addEventListener('change',()=>{
        if(activeMIDIInput) activeMIDIInput.onmidimessage=null;
        const inp=ma.inputs.get(midiSelect.value);
        if(inp){ inp.onmidimessage=handleMIDI; activeMIDIInput=inp; estadoEl.innerText=`Transmitiendo desde: ${inp.name}`; }
        else{ estadoEl.innerText='Dispositivo MIDI no encontrado.'; }
      });
      // auto select first
      midiSelect.value=inputs[0].id;
      midiSelect.dispatchEvent(new Event('change'));
    }).catch(()=>{ estadoEl.innerText='No se pudo acceder al MIDI.'; });

    function handleMIDI(evt){
      const now=performance.now(); if(!startTime) startTime=now;
      const rel=now-startTime;
      if(midiChannel&&midiChannel.readyState==='open') midiChannel.send(JSON.stringify({data:Array.from(evt.data),time:rel}));
    }
  </script>
</body>
</html>
