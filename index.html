<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DreamEcho - Artista Bidireccional</title>
  <style>
    body { margin:0; font-family:sans-serif; background:#f5f5f5; display:flex; flex-direction:column; align-items:center; }
    .container { max-width:800px; width:95%; background:white; padding:1em; margin:1em; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align:center; }
    video { width:48%; background:black; border-radius:4px; }
    .videos { display:flex; justify-content:space-between; margin:1em 0; }
    #status, #oyentes { text-align:center; margin:0.5em 0; }
    #midiSelectContainer, #chatControles, .buttons { margin:0.5em 0; text-align:center; }
    select, input, button { font-size:1em; padding:0.5em; margin:0.2em; }
    #chatLog { height:120px; overflow-y:auto; border:1px solid #ccc; padding:0.5em; background:#fafafa; }
    .chat-propio { color:blue; }
  </style>
</head>
<body>
  <div class="container">
    <h1>DreamEcho - Artista</h1>
    <div class="videos">
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
    <p id="status">Conectando...</p>
    <p id="oyentes">Oyentes: --</p>
    <div class="buttons">
      <button onclick="modoMIDI()">ðŸŽ¹ Piano Digital</button>
      <button onclick="modoVirtual()">ðŸŽ§ Piano Virtual</button>
    </div>
    <div id="midiSelectContainer"></div>
    <div id="chatControles">
      <div id="chatLog"></div>
      <input id="chatInput" placeholder="Mensajeâ€¦" /><button id="sendChatBtn">Enviar</button>
    </div>
  </div>

  <script>
    // DOM
    const statusEl = document.getElementById('status');
    const oyentesEl = document.getElementById('oyentes');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const chatLog = document.getElementById('chatLog');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const midiSelectContainer = document.getElementById('midiSelectContainer');

    // State
    let pc, ws, midiChannel, audioTrack, muteTimeout;
    let output = null, synth = null, pedal=false;
    const notasActivas = new Set(), notasSostenidas = new Set();
    const username = prompt('Tu nombre:', 'Artista')||'Artista';

    // Setup WebSocket + PeerConnection
    ws = new WebSocket('wss://dreamecho.onrender.com');
    pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}]});

    ws.onopen = () => { statusEl.textContent='Conectado, esperando negociaciÃ³n...'; initMedia(); };
    ws.onmessage = async ({data}) => {
      const msg = JSON.parse(typeof data==='string'?data:await data.text());
      if(msg.type==='stats'){ oyentesEl.textContent=`Oyentes: ${msg.clients}`; return; }
      if(msg.type==='chat'){ appendChat(msg.user,msg.text); return; }
      if(msg.type==='signal'){
        if(msg.offer){
          await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
          const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({type:'signal',answer:pc.localDescription}));
        } else if(msg.answer){ await pc.setRemoteDescription(new RTCSessionDescription(msg.answer)); }
        else if(msg.candidate){ await pc.addIceCandidate(new RTCIceCandidate(msg.candidate)); }
      }
    };
    ws.onerror = () => statusEl.textContent='Error conexiÃ³n.';
    ws.onclose = () => statusEl.textContent='Desconectado.';

    pc.onicecandidate = ({candidate})=>{ if(candidate) ws.send(JSON.stringify({type:'signal',candidate})); };
    pc.ontrack = ev => { remoteVideo.srcObject = ev.streams[0]; };
    pc.ondatachannel = ev => {
      if(ev.channel.label==='midi'){ midiChannel = ev.channel; midiChannel.onmessage = e=>handleMidiMessage(JSON.parse(e.data)); }
    };

    function initMedia(){
      navigator.mediaDevices.getUserMedia({video:true,audio:true})
        .then(stream=>{
          // Local media
          stream.getTracks().forEach(t=>pc.addTrack(t,stream));
          localVideo.srcObject=stream;
          audioTrack=stream.getAudioTracks()[0];
          // Midi channel creation
          midiChannel = pc.createDataChannel('midi'); setupMidiChannel(midiChannel);
          // Create and send offer
          pc.createOffer().then(o=>pc.setLocalDescription(o)).then(()=>{
            ws.send(JSON.stringify({type:'signal',offer:pc.localDescription}));
          });
        }).catch(e=>{ console.error(e); statusEl.textContent='No se pudo acceder a cÃ¡mara/mic.'; });
    }

    function setupMidiChannel(ch){
      ch.onopen = ()=>{};
      ch.onmessage = ({data})=>handleMidiMessage(JSON.parse(data));
    }

    // Chat
    appendChat = (u,t)=>{
      const d=document.createElement('div'); d.innerHTML=`<small>[${new Date().toLocaleTimeString()}]</small> <strong>${u}:</strong> ${t}`;
      if(u===username) d.classList.add('chat-propio'); chatLog.appendChild(d); chatLog.scrollTop=chatLog.scrollHeight;
    };
    sendChatBtn.onclick = ()=>{ const t=chatInput.value.trim(); if(t&&ws.readyState===WebSocket.OPEN){ ws.send(JSON.stringify({type:'chat',user:username,text:t})); chatInput.value=''; }};
    chatInput.onkeydown = e=>{ if(e.key==='Enter') sendChatBtn.click(); };

    // MIDI input
    function modoMIDI(){
      navigator.requestMIDIAccess().then(ma=>{
        midiSelectContainer.innerHTML='';
        const sel=document.createElement('select'); sel.innerHTML='<option>--Salida MIDI--</option>';
        Array.from(ma.outputs.values()).forEach(o=>sel.innerHTML+=`<option value="${o.id}">${o.name}</option>`);
        sel.onchange = ()=>{ output = ma.outputs.get(sel.value); };
        sel.value = ma.outputs.values().next().value.id; sel.dispatchEvent(new Event('change'));
        midiSelectContainer.appendChild(sel);
      });
    }

    // Virtual piano
    async function modoVirtual(){
      await Tone.start();
      synth = new Tone.Sampler({
        urls:{A4:'A4.mp3'}, baseUrl:'https://tonejs.github.io/audio/salamander/', release:0.4,
        onload:()=>{}
      }).toDestination();
    }

    // Handle incoming and outgoing MIDI
    function handleMidiMessage(msg){
      // Remote incoming: schedule play (omitted for brevity)
    }

    function selectMidiInput(input){
      // Called on <select> change (omitted)
    }

    navigator.requestMIDIAccess().then(ma=>{
      ma.inputs.forEach(inp=>{
        inp.onmidimessage = evt=>{
          // Mute mic briefly
          if(audioTrack){ audioTrack.enabled=false; clearTimeout(muteTimeout); muteTimeout=setTimeout(()=>audioTrack.enabled=true,200); }
          // Send midi
          if(midiChannel&&midiChannel.readyState==='open') midiChannel.send(JSON.stringify({data:Array.from(evt.data),time:performance.now()}));
        };
      });
    }).catch(()=>{});
  </script>
</body>
</html>
